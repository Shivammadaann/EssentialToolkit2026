<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shivam's Essential Toolkit Pro</title>
    <meta name="description" content="A comprehensive personal desktop operating system with productivity apps">
    <meta name="author" content="Shivam's Essential Toolkit Pro">
    <!-- CSP compatible with Electron (relaxed for development) -->
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com;">
    <link rel="icon" type="image/png" href="assets/icon.png">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#0a0a0a',
                        'dark-card': '#1a1a1a',
                        'dark-border': '#2a2a2a',
                        'dark-hover': '#2a2a2a',
                        'light-bg': '#f8fafc',
                        'light-card': '#ffffff',
                        'light-border': '#e2e8f0',
                        'light-hover': '#f1f5f9',
                        'accent': '#007AFF',
                        'accent-hover': '#0056CC'
                    },
                    fontFamily: {
                        'system': ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'scale-in': 'scaleIn 0.2s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-slow': 'pulse 3s ease-in-out infinite'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideIn: { '0%': { transform: 'translateX(-20px)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
                        scaleIn: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
        
        .dark { --scrollbar-track: #1a1a1a; --scrollbar-thumb: #333; }
        .light { --scrollbar-track: #f1f5f9; --scrollbar-thumb: #ccc; }
        
        * { transition: background-color 0.3s, color 0.3s, border-color 0.3s, transform 0.2s; -webkit-tap-highlight-color: transparent; }
        
        .rich-editor { min-height: 300px; outline: none; overflow-y: auto; max-height: calc(100vh - 200px); }
        .rich-editor:empty:before { content: attr(placeholder); color: #888; pointer-events: none; display: block; }
        
        /* Mobile Specifics */
        @media (max-width: 768px) {
            .app-card { padding: 1rem; }
            .rich-editor { min-height: 50vh; }
            ::-webkit-scrollbar { display: none; }
        }
        
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem; }
        @media (min-width: 768px) {
            .photo-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
        }

        .custom-bg { background-size: cover; background-position: center; background-repeat: no-repeat; }
        
        /* Utility for mobile stacking */
        .mobile-stack-panel {
            position: absolute; inset: 0; background-color: inherit; z-index: 10;
            display: flex; flex-direction: column;
        }
        @media (min-width: 768px) {
            .mobile-stack-panel { position: static; z-index: auto; }
        }
        
        /* Ensure content is visible even if Lucide fails */
        i[data-lucide] { display: inline-block; min-width: 1em; min-height: 1em; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "@radix-ui/react-alert-dialog": "https://esm.sh/@radix-ui/react-alert-dialog@^1.1.15",
    "react/": "https://esm.sh/react@^19.2.3/",
    "class-variance-authority": "https://esm.sh/class-variance-authority@^0.7.1",
    "@radix-ui/react-accordion": "https://esm.sh/@radix-ui/react-accordion@^1.2.12",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "@radix-ui/react-checkbox": "https://esm.sh/@radix-ui/react-checkbox@^1.3.3",
    "@radix-ui/react-slot": "https://esm.sh/@radix-ui/react-slot@^1.2.4",
    "@radix-ui/react-aspect-ratio": "https://esm.sh/@radix-ui/react-aspect-ratio@^1.1.8",
    "recharts": "https://esm.sh/recharts@^3.6.0",
    "@radix-ui/react-avatar": "https://esm.sh/@radix-ui/react-avatar@^1.1.11",
    "embla-carousel-react": "https://esm.sh/embla-carousel-react@^8.6.0",
    "react-day-picker": "https://esm.sh/react-day-picker@^9.13.0",
    "@radix-ui/react-collapsible": "https://esm.sh/@radix-ui/react-collapsible@^1.1.12",
    "path": "https://esm.sh/path@^0.12.7",
    "url": "https://esm.sh/url@^0.11.4",
    "@eslint/eslintrc": "https://esm.sh/@eslint/eslintrc@^3.3.3",
    "@radix-ui/react-dropdown-menu": "https://esm.sh/@radix-ui/react-dropdown-menu@^2.1.16",
    "vaul": "https://esm.sh/vaul@^1.1.2",
    "@radix-ui/react-dialog": "https://esm.sh/@radix-ui/react-dialog@^1.1.15",
    "@radix-ui/react-label": "https://esm.sh/@radix-ui/react-label@^2.1.8",
    "react-hook-form": "https://esm.sh/react-hook-form@^7.69.0",
    "cmdk": "https://esm.sh/cmdk@^1.1.1",
    "@radix-ui/react-context-menu": "https://esm.sh/@radix-ui/react-context-menu@^2.2.16",
    "next": "https://esm.sh/next@^16.1.1",
    "@radix-ui/react-hover-card": "https://esm.sh/@radix-ui/react-hover-card@^1.1.15",
    "input-otp": "https://esm.sh/input-otp@^1.4.2",
    "@radix-ui/react-navigation-menu": "https://esm.sh/@radix-ui/react-navigation-menu@^1.2.14",
    "@radix-ui/react-menubar": "https://esm.sh/@radix-ui/react-menubar@^1.1.16",
    "react-resizable-panels": "https://esm.sh/react-resizable-panels@^4.1.1",
    "@radix-ui/react-popover": "https://esm.sh/@radix-ui/react-popover@^1.1.15",
    "@radix-ui/react-radio-group": "https://esm.sh/@radix-ui/react-radio-group@^1.3.8",
    "@radix-ui/react-progress": "https://esm.sh/@radix-ui/react-progress@^1.1.8",
    "@radix-ui/react-slider": "https://esm.sh/@radix-ui/react-slider@^1.3.6",
    "@radix-ui/react-switch": "https://esm.sh/@radix-ui/react-switch@^1.2.6",
    "@radix-ui/react-select": "https://esm.sh/@radix-ui/react-select@^2.2.6",
    "@radix-ui/react-separator": "https://esm.sh/@radix-ui/react-separator@^1.1.8",
    "next-themes": "https://esm.sh/next-themes@^0.4.6",
    "sonner": "https://esm.sh/sonner@^2.0.7",
    "@radix-ui/react-scroll-area": "https://esm.sh/@radix-ui/react-scroll-area@^1.2.10",
    "@radix-ui/react-toggle": "https://esm.sh/@radix-ui/react-toggle@^1.1.10",
    "clsx": "https://esm.sh/clsx@^2.1.1",
    "tailwind-merge": "https://esm.sh/tailwind-merge@^3.4.0",
    "@radix-ui/react-tabs": "https://esm.sh/@radix-ui/react-tabs@^1.1.13",
    "@radix-ui/react-tooltip": "https://esm.sh/@radix-ui/react-tooltip@^1.2.8",
    "@radix-ui/react-toggle-group": "https://esm.sh/@radix-ui/react-toggle-group@^1.1.11"
  }
}
</script>
</head>
<body class="bg-light-bg dark:bg-dark-bg text-gray-900 dark:text-white font-system overflow-hidden h-screen w-screen touch-manipulation">
    
    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden transition-opacity opacity-0"></div>

    <!-- Main Container -->
    <div id="app" class="flex h-full w-full">
        <!-- Sidebar -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 md:w-16 bg-light-card dark:bg-dark-card border-r border-light-border dark:border-dark-border flex flex-col items-center py-4 space-y-2 transform -translate-x-full md:translate-x-0 transition-transform duration-300 md:static shrink-0 shadow-2xl md:shadow-none">
            <div class="w-full md:w-auto flex items-center justify-between md:justify-center px-4 md:px-0 mb-4">
                <div class="w-10 h-10 bg-accent rounded-xl flex items-center justify-center animate-pulse-slow shrink-0 shadow-lg shadow-accent/20">
                    <i data-lucide="grid-3x3" class="w-6 h-6 text-white"></i>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden p-2 text-gray-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <div class="flex-1 w-full px-2 space-y-2 overflow-y-auto">
                <button onclick="switchApp('home')" class="sidebar-btn w-full md:w-10 h-12 md:h-10 rounded-xl flex items-center md:justify-center px-4 md:px-0 hover:bg-light-hover dark:hover:bg-dark-hover transition-all duration-200 group" data-app="home">
                    <i data-lucide="home" class="w-5 h-5 shrink-0 group-hover:scale-110 transition-transform"></i>
                    <span class="md:hidden ml-3 font-medium">Home</span>
                </button>
                
                <button onclick="switchApp('notes')" class="sidebar-btn w-full md:w-10 h-12 md:h-10 rounded-xl flex items-center md:justify-center px-4 md:px-0 hover:bg-light-hover dark:hover:bg-dark-hover transition-all duration-200 group" data-app="notes">
                    <i data-lucide="file-text" class="w-5 h-5 shrink-0 group-hover:scale-110 transition-transform"></i>
                    <span class="md:hidden ml-3 font-medium">Notes</span>
                </button>
                
                <button onclick="switchApp('photos')" class="sidebar-btn w-full md:w-10 h-12 md:h-10 rounded-xl flex items-center md:justify-center px-4 md:px-0 hover:bg-light-hover dark:hover:bg-dark-hover transition-all duration-200 group" data-app="photos">
                    <i data-lucide="image" class="w-5 h-5 shrink-0 group-hover:scale-110 transition-transform"></i>
                    <span class="md:hidden ml-3 font-medium">Photos</span>
                </button>
                
                <button onclick="switchApp('passwords')" class="sidebar-btn w-full md:w-10 h-12 md:h-10 rounded-xl flex items-center md:justify-center px-4 md:px-0 hover:bg-light-hover dark:hover:bg-dark-hover transition-all duration-200 group" data-app="passwords">
                    <i data-lucide="key" class="w-5 h-5 shrink-0 group-hover:scale-110 transition-transform"></i>
                    <span class="md:hidden ml-3 font-medium">Passwords</span>
                </button>
                
                <button onclick="switchApp('contacts')" class="sidebar-btn w-full md:w-10 h-12 md:h-10 rounded-xl flex items-center md:justify-center px-4 md:px-0 hover:bg-light-hover dark:hover:bg-dark-hover transition-all duration-200 group" data-app="contacts">
                    <i data-lucide="users" class="w-5 h-5 shrink-0 group-hover:scale-110 transition-transform"></i>
                    <span class="md:hidden ml-3 font-medium">Contacts</span>
                </button>
                
                <button onclick="switchApp('urls')" class="sidebar-btn w-full md:w-10 h-12 md:h-10 rounded-xl flex items-center md:justify-center px-4 md:px-0 hover:bg-light-hover dark:hover:bg-dark-hover transition-all duration-200 group" data-app="urls">
                    <i data-lucide="link" class="w-5 h-5 shrink-0 group-hover:scale-110 transition-transform"></i>
                    <span class="md:hidden ml-3 font-medium">URL Dashboard</span>
                </button>
                
                <button onclick="switchApp('settings')" class="sidebar-btn w-full md:w-10 h-12 md:h-10 rounded-xl flex items-center md:justify-center px-4 md:px-0 hover:bg-light-hover dark:hover:bg-dark-hover transition-all duration-200 group" data-app="settings">
                    <i data-lucide="settings" class="w-5 h-5 shrink-0 group-hover:scale-110 transition-transform"></i>
                    <span class="md:hidden ml-3 font-medium">Settings</span>
                </button>
            </div>
            
            <div class="w-full px-2 pb-2">
                <button onclick="switchApp('profile')" class="sidebar-btn w-full md:w-10 h-12 md:h-10 rounded-xl flex items-center md:justify-center px-4 md:px-0 hover:bg-light-hover dark:hover:bg-dark-hover transition-all duration-200 group" data-app="profile">
                    <div class="w-8 h-8 profile-avatar rounded-full flex items-center justify-center shrink-0 ring-2 ring-transparent group-hover:ring-accent transition-all">
                        <i data-lucide="user" class="w-4 h-4 text-white"></i>
                    </div>
                    <span class="md:hidden ml-3 font-medium">Profile</span>
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden relative w-full">
            <!-- Header -->
            <div id="header" class="h-14 shrink-0 bg-light-card/80 dark:bg-dark-card/80 backdrop-blur-md border-b border-light-border dark:border-dark-border flex items-center justify-between px-4 sticky top-0 z-30 transition-colors duration-300">
                <div class="flex items-center space-x-3">
                    <button onclick="toggleSidebar()" class="md:hidden p-2 -ml-2 text-gray-600 dark:text-gray-300 hover:bg-light-hover dark:hover:bg-dark-hover rounded-lg transition-colors">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    <button onclick="switchApp('home')" class="hidden md:block text-accent hover:text-accent-hover transition-colors duration-300 hover:scale-110">
                        <i data-lucide="grid-3x3" class="w-5 h-5"></i>
                    </button>
                    <span id="app-title" class="text-base font-semibold truncate max-w-[200px]">Shivam's Essential Toolkit Pro</span>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-light-hover dark:hover:bg-dark-hover transition-all duration-300 active:scale-95" title="Toggle Theme">
                        <i data-lucide="sun" class="w-5 h-5 dark:hidden"></i>
                        <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                    </button>
                    <div class="hidden sm:block text-xs font-mono text-gray-500 dark:text-gray-400 bg-light-hover dark:bg-dark-hover px-2 py-1 rounded" id="current-time"></div>
                </div>
            </div>
            
            <!-- App Content Container -->
            <div class="flex-1 overflow-hidden relative w-full">
                <!-- Home App -->
                <div id="home-app" class="app-content h-full w-full absolute inset-0 overflow-y-auto p-4 md:p-8 animate-fade-in bg-gray-900 custom-bg" style="background-image: url('');">
                    <div class="bg-black/40 backdrop-blur-sm rounded-2xl p-6 md:p-8 min-h-full" id="home-overlay">
                        <div class="max-w-6xl mx-auto flex flex-col h-full justify-center">
                            <div class="text-center mb-8 md:mb-12 animate-slide-up">
                                <h1 class="text-3xl md:text-5xl font-bold mb-2 md:mb-4 text-white drop-shadow-lg">Shivam's Essential Toolkit Pro</h1>
                                <p class="text-gray-200 text-sm md:text-lg mb-4 opacity-90">Your personal productivity desktop</p>
                                <div class="text-white/80 animate-slide-in">
                                    <div id="home-date-time" class="text-lg md:text-xl font-medium"></div>
                                </div>
                            </div>
                            
                            <div id="apps-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6 pb-20"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Notes App -->
                <div id="notes-app" class="app-content h-full w-full absolute inset-0 hidden animate-fade-in bg-light-bg dark:bg-dark-bg">
                    <div class="flex h-full relative overflow-hidden">
                        <!-- Folders Sidebar -->
                        <div id="notes-folders-panel" class="mobile-stack-panel w-full md:w-64 border-r border-light-border dark:border-dark-border bg-light-card dark:bg-dark-card md:flex">
                            <div class="p-4 border-b border-light-border dark:border-dark-border flex items-center justify-between">
                                <h3 class="font-semibold text-lg">Folders</h3>
                                <button onclick="createFolder()" class="p-2 bg-accent/10 text-accent rounded-lg hover:bg-accent/20 transition-colors">
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div id="folders-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                                <div class="folder-item p-3 rounded-lg hover:bg-light-hover dark:hover:bg-dark-hover cursor-pointer bg-light-hover dark:bg-dark-hover transition-all duration-300 font-medium" data-folder="all" onclick="mobileNavigateNotes('list')">
                                    <i data-lucide="folder" class="w-5 h-5 inline mr-3 text-accent"></i>
                                    All Notes
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes List -->
                        <div id="notes-list-panel" class="mobile-stack-panel w-full md:w-80 border-r border-light-border dark:border-dark-border bg-light-card dark:bg-dark-card hidden md:flex">
                            <div class="p-4 border-b border-light-border dark:border-dark-border">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center">
                                        <button onclick="mobileNavigateNotes('folders')" class="md:hidden mr-3 p-1 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
                                            <i data-lucide="chevron-left" class="w-6 h-6"></i>
                                        </button>
                                        <h3 class="font-semibold text-lg">Notes</h3>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <button onclick="toggleNotesView()" class="p-2 text-gray-500 hover:text-accent transition-all duration-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
                                            <i id="notes-view-icon" data-lucide="layout-grid" class="w-5 h-5"></i>
                                        </button>
                                        <button onclick="createNote()" class="p-2 text-accent hover:text-accent-hover transition-all duration-300 rounded-lg hover:bg-accent/10">
                                            <i data-lucide="plus" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="notes-list" class="flex-1 overflow-y-auto p-3 space-y-2 pb-20 md:pb-4"></div>
                        </div>
                        
                        <!-- Editor -->
                        <div id="notes-editor-panel" class="mobile-stack-panel flex-1 min-w-0 bg-light-bg dark:bg-dark-bg hidden md:flex flex-col">
                            <div class="border-b border-light-border dark:border-dark-border p-3 md:p-4 bg-light-card dark:bg-dark-card flex flex-col gap-3">
                                <div class="flex items-center w-full">
                                    <button onclick="mobileNavigateNotes('list')" class="md:hidden mr-3 p-1 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
                                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                                    </button>
                                    <input id="note-title" type="text" placeholder="Note title..." class="flex-1 bg-transparent text-lg md:text-xl font-semibold border-none outline-none placeholder-gray-400">
                                </div>
                                <div class="flex items-center space-x-1 overflow-x-auto no-scrollbar py-1">
                                    <button onclick="formatText('bold')" class="p-2 rounded hover:bg-light-hover dark:hover:bg-dark-hover transition-all">
                                        <i data-lucide="bold" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="formatText('italic')" class="p-2 rounded hover:bg-light-hover dark:hover:bg-dark-hover transition-all">
                                        <i data-lucide="italic" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="formatText('underline')" class="p-2 rounded hover:bg-light-hover dark:hover:bg-dark-hover transition-all">
                                        <i data-lucide="underline" class="w-4 h-4"></i>
                                    </button>
                                    <div class="w-px h-6 bg-gray-300 dark:bg-gray-700 mx-2"></div>
                                    <span id="note-status" class="text-xs text-gray-400 ml-auto">Saved</span>
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto p-4 md:p-8">
                                <div id="note-editor" class="rich-editor w-full h-full bg-transparent border-none outline-none text-gray-700 dark:text-gray-300 text-base leading-relaxed" contenteditable="true" placeholder="Start writing..."></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Photos App -->
                <div id="photos-app" class="app-content h-full w-full absolute inset-0 overflow-y-auto hidden p-4 md:p-6 animate-fade-in bg-light-bg dark:bg-dark-bg">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                        <h2 class="text-2xl font-bold">Photos</h2>
                        <div class="flex flex-wrap items-center gap-2">
                            <button onclick="openCloudImportModal()" class="flex-1 md:flex-none bg-blue-500 hover:bg-blue-600 px-3 py-2 rounded-lg flex items-center justify-center space-x-2 text-white text-sm">
                                <i data-lucide="cloud" class="w-4 h-4"></i>
                                <span class="hidden sm:inline">Import</span>
                            </button>
                            <input type="file" id="photo-input" accept="image/*" multiple class="hidden">
                            <button onclick="document.getElementById('photo-input').click()" class="flex-1 md:flex-none bg-accent hover:bg-accent-hover px-3 py-2 rounded-lg flex items-center justify-center space-x-2 text-white text-sm">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                <span>Upload</span>
                            </button>
                            <button onclick="createAlbum()" class="flex-1 md:flex-none bg-green-500 hover:bg-green-600 px-3 py-2 rounded-lg flex items-center justify-center space-x-2 text-white text-sm">
                                <i data-lucide="folder-plus" class="w-4 h-4"></i>
                                <span>Album</span>
                            </button>
                        </div>
                    </div>
                    <div class="mb-6 overflow-x-auto no-scrollbar">
                        <div class="flex items-center space-x-2 mb-4 min-w-max">
                            <button onclick="showPhotosView('all')" class="photos-tab px-4 py-2 rounded-full text-sm font-medium bg-accent text-white shadow-sm" data-view="all">All Photos</button>
                            <button onclick="showPhotosView('albums')" class="photos-tab px-4 py-2 rounded-full text-sm font-medium bg-light-card dark:bg-dark-card hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-view="albums">Albums</button>
                        </div>
                        <div id="albums-list" class="hidden grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 pb-20"></div>
                    </div>
                    <div id="photos-grid" class="photo-grid pb-20"></div>
                </div>
                
                <!-- Password Manager App -->
                <div id="passwords-app" class="app-content h-full w-full absolute inset-0 overflow-y-auto hidden p-4 md:p-6 animate-fade-in bg-light-bg dark:bg-dark-bg">
                    <div class="flex items-center justify-between mb-6 sticky top-0 bg-light-bg dark:bg-dark-bg z-10 py-2">
                        <h2 class="text-2xl font-bold">Passwords</h2>
                        <div class="flex items-center space-x-3">
                            <button onclick="togglePasswordsView()" class="p-2 rounded-lg bg-light-card dark:bg-dark-card hover:bg-accent hover:text-white transition-all shadow-sm">
                                <i id="passwords-view-icon" data-lucide="layout-list" class="w-5 h-5"></i>
                            </button>
                            <button onclick="openPasswordModal()" class="bg-accent hover:bg-accent-hover px-4 py-2 rounded-lg flex items-center space-x-2 text-white shadow-lg shadow-accent/20">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                <span class="hidden sm:inline">Add</span>
                            </button>
                        </div>
                    </div>
                    <div id="passwords-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20"></div>
                </div>
                
                <!-- Contacts App -->
                <div id="contacts-app" class="app-content h-full w-full absolute inset-0 hidden animate-fade-in bg-light-bg dark:bg-dark-bg">
                    <div class="flex h-full relative overflow-hidden">
                        <!-- Contacts List -->
                        <div id="contacts-list-panel" class="mobile-stack-panel w-full md:w-80 border-r border-light-border dark:border-dark-border bg-light-card dark:bg-dark-card md:flex">
                            <div class="p-4 border-b border-light-border dark:border-dark-border sticky top-0 bg-inherit z-10">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold text-lg">Contacts</h3>
                                    <div class="flex items-center space-x-1">
                                        <button onclick="selectAllContacts()" class="p-2 text-accent hover:bg-accent/10 rounded-lg">
                                            <i data-lucide="check-square" class="w-5 h-5"></i>
                                        </button>
                                        <button onclick="exportContacts()" class="p-2 text-accent hover:bg-accent/10 rounded-lg">
                                            <i data-lucide="download" class="w-5 h-5"></i>
                                        </button>
                                        <button onclick="openContactModal()" class="p-2 text-accent hover:bg-accent/10 rounded-lg">
                                            <i data-lucide="plus" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="relative">
                                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                                    <input id="contact-search" type="text" placeholder="Search..." class="w-full bg-light-hover dark:bg-dark-hover border-none rounded-xl pl-10 pr-4 py-2 text-sm focus:ring-2 focus:ring-accent/50">
                                </div>
                            </div>
                            <div id="contacts-list" class="flex-1 overflow-y-auto p-2 space-y-1 pb-20 md:pb-2"></div>
                        </div>
                        <!-- Contact Details -->
                        <div id="contacts-details-panel" class="mobile-stack-panel flex-1 bg-light-bg dark:bg-dark-bg hidden md:block overflow-y-auto">
                            <div class="md:hidden p-4 border-b border-light-border dark:border-dark-border flex items-center bg-light-card dark:bg-dark-card sticky top-0 z-10">
                                <button onclick="mobileNavigateContacts('list')" class="mr-3 p-1 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
                                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                                </button>
                                <span class="font-semibold">Details</span>
                            </div>
                            <div id="contact-details" class="flex flex-col items-center justify-center h-full p-6 text-center text-gray-400">
                                <div>
                                    <i data-lucide="user" class="w-20 h-20 mx-auto mb-4 opacity-20"></i>
                                    <p>Select a contact to view details</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- URL Dashboard App -->
                <div id="urls-app" class="app-content h-full w-full absolute inset-0 overflow-y-auto hidden p-4 md:p-6 animate-fade-in bg-light-bg dark:bg-dark-bg">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                        <h2 class="text-2xl font-bold">Dashboard</h2>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleUrlsView()" class="p-2 rounded-lg bg-light-card dark:bg-dark-card hover:bg-accent hover:text-white transition-all shadow-sm">
                                <i id="urls-view-icon" data-lucide="layout-list" class="w-5 h-5"></i>
                            </button>
                            <button onclick="createUrlFolder()" class="flex-1 bg-green-500 hover:bg-green-600 px-3 py-2 rounded-lg flex items-center space-x-2 text-white text-sm shadow-md">
                                <i data-lucide="folder-plus" class="w-4 h-4"></i>
                                <span class="hidden sm:inline">Folder</span>
                            </button>
                            <button onclick="openUrlModal()" class="flex-1 bg-accent hover:bg-accent-hover px-3 py-2 rounded-lg flex items-center space-x-2 text-white text-sm shadow-md">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                <span>Add URL</span>
                            </button>
                        </div>
                    </div>
                    <div class="mb-6 overflow-x-auto no-scrollbar">
                        <div class="flex items-center space-x-2 min-w-max pb-2">
                            <span class="text-sm font-medium text-gray-500 mr-2">Folders:</span>
                            <div id="url-folders" class="flex items-center space-x-2">
                                <!-- Folders rendered via JS -->
                            </div>
                        </div>
                    </div>
                    <div id="urls-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20"></div>
                </div>
                
                <!-- Settings App -->
                <div id="settings-app" class="app-content h-full w-full absolute inset-0 overflow-y-auto hidden p-4 md:p-6 animate-fade-in bg-light-bg dark:bg-dark-bg">
                    <div class="max-w-4xl mx-auto pb-20">
                        <h2 class="text-2xl font-bold mb-6">Settings</h2>
                        <div class="space-y-4">
                            <div class="bg-light-card dark:bg-dark-card rounded-2xl p-5 shadow-sm">
                                <h3 class="text-lg font-semibold mb-4">Background</h3>
                                <div class="space-y-4">
                                    <label class="block text-sm font-medium mb-2 text-gray-500">Custom Wallpaper</label>
                                    <div class="flex gap-3">
                                        <input type="file" id="background-input" accept="image/*" class="hidden">
                                        <button onclick="document.getElementById('background-input').click()" class="flex-1 bg-accent hover:bg-accent-hover py-2.5 rounded-xl text-white transition-all active:scale-95">Choose Image</button>
                                        <button onclick="removeBackground()" class="flex-1 bg-red-500 hover:bg-red-600 py-2.5 rounded-xl text-white transition-all active:scale-95">Remove</button>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-light-card dark:bg-dark-card rounded-2xl p-5 shadow-sm">
                                <h3 class="text-lg font-semibold mb-4">Appearance</h3>
                                <div class="grid grid-cols-3 gap-3">
                                    <button onclick="setTheme('light')" class="py-2.5 rounded-xl border border-light-border dark:border-dark-border hover:bg-light-hover dark:hover:bg-dark-hover transition-all text-sm font-medium">Light</button>
                                    <button onclick="setTheme('dark')" class="py-2.5 rounded-xl border border-light-border dark:border-dark-border hover:bg-light-hover dark:hover:bg-dark-hover transition-all text-sm font-medium">Dark</button>
                                    <button onclick="setTheme('auto')" class="py-2.5 rounded-xl border border-light-border dark:border-dark-border hover:bg-light-hover dark:hover:bg-dark-hover transition-all text-sm font-medium">Auto</button>
                                </div>
                            </div>
                            <div class="bg-light-card dark:bg-dark-card rounded-2xl p-5 shadow-sm">
                                <h3 class="text-lg font-semibold mb-4">App Layout</h3>
                                <p class="text-sm text-gray-500 mb-4">Rearrange home screen apps.</p>
                                <button onclick="resetAppOrder()" class="w-full bg-gray-500 hover:bg-gray-600 py-2.5 rounded-xl text-white transition-all active:scale-95">Reset Order</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Profile App -->
                <div id="profile-app" class="app-content h-full w-full absolute inset-0 overflow-y-auto hidden p-4 md:p-6 animate-fade-in bg-light-bg dark:bg-dark-bg">
                    <div class="max-w-2xl mx-auto pb-20">
                        <div class="bg-light-card dark:bg-dark-card rounded-2xl p-6 md:p-8 shadow-sm">
                            <div class="text-center mb-8 relative">
                                <div class="relative inline-block group">
                                    <div id="profile-avatar" class="w-28 h-28 md:w-32 md:h-32 profile-avatar rounded-full flex items-center justify-center mx-auto mb-4 shadow-xl ring-4 ring-light-bg dark:ring-dark-bg overflow-hidden">
                                        <i data-lucide="user" class="w-12 h-12 text-white"></i>
                                    </div>
                                    <button onclick="changeProfilePicture()" class="absolute bottom-4 right-0 bg-accent hover:bg-accent-hover p-2.5 rounded-full text-white shadow-lg transition-transform active:scale-90">
                                        <i data-lucide="camera" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                <input type="file" id="profile-picture-input" accept="image/*" class="hidden">
                            </div>
                            <form id="profile-form" class="space-y-5">
                                <div>
                                    <label class="block text-sm font-medium mb-1.5 ml-1 text-gray-500">Full Name</label>
                                    <input type="text" id="profile-name" placeholder="Your Name" class="w-full bg-light-hover dark:bg-dark-hover border-transparent rounded-xl px-4 py-3 focus:ring-2 focus:ring-accent/50 outline-none transition-all">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1.5 ml-1 text-gray-500">Email</label>
                                    <input type="email" id="profile-email" placeholder="email@example.com" class="w-full bg-light-hover dark:bg-dark-hover border-transparent rounded-xl px-4 py-3 focus:ring-2 focus:ring-accent/50 outline-none transition-all">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1.5 ml-1 text-gray-500">Bio</label>
                                    <textarea id="profile-bio" placeholder="A short bio..." rows="4" class="w-full bg-light-hover dark:bg-dark-hover border-transparent rounded-xl px-4 py-3 focus:ring-2 focus:ring-accent/50 outline-none transition-all resize-none"></textarea>
                                </div>
                                <button type="submit" class="w-full bg-accent hover:bg-accent-hover py-3.5 rounded-xl font-semibold text-white shadow-lg shadow-accent/20 transition-all active:scale-[0.98] mt-4">
                                    Save Profile
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="password-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[60] hidden animate-fade-in p-4">
        <div class="bg-light-card dark:bg-dark-card rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-scale-in">
            <h3 class="text-xl font-bold mb-4" id="password-modal-title">Add Password</h3>
            <form id="password-form" class="space-y-3">
                <input type="hidden" id="password-edit-id">
                <input type="text" id="service-name" placeholder="Service Name" class="w-full bg-light-hover dark:bg-dark-hover rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-accent/50" required>
                <input type="url" id="service-url" placeholder="https://..." class="w-full bg-light-hover dark:bg-dark-hover rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-accent/50">
                <input type="text" id="username" placeholder="Username" class="w-full bg-light-hover dark:bg-dark-hover rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-accent/50" required>
                <input type="password" id="password" placeholder="Password" class="w-full bg-light-hover dark:bg-dark-hover rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-accent/50" required>
                <div class="flex gap-3 mt-2">
                    <button type="button" onclick="closePasswordModal()" class="flex-1 bg-gray-200 dark:bg-gray-700 py-3 rounded-xl font-medium">Cancel</button>
                    <button type="submit" class="flex-1 bg-accent text-white py-3 rounded-xl font-medium shadow-lg shadow-accent/20">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="contact-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[60] hidden animate-fade-in p-4">
        <div class="bg-light-card dark:bg-dark-card rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-scale-in">
            <h3 class="text-xl font-bold mb-4" id="contact-modal-title">Add Contact</h3>
            <form id="contact-form" class="space-y-4">
                <input type="hidden" id="contact-edit-id">
                <div class="flex justify-center">
                    <div class="relative cursor-pointer group" onclick="document.getElementById('contact-picture-input').click()">
                        <div id="contact-avatar-preview" class="w-20 h-20 bg-accent rounded-full flex items-center justify-center overflow-hidden">
                            <i data-lucide="user" class="w-8 h-8 text-white"></i>
                        </div>
                        <div class="absolute inset-0 bg-black/30 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <i data-lucide="camera" class="w-6 h-6 text-white"></i>
                        </div>
                    </div>
                    <input type="file" id="contact-picture-input" accept="image/*" class="hidden">
                </div>
                <div class="space-y-3">
                    <input type="text" id="contact-name" placeholder="Full Name" class="w-full bg-light-hover dark:bg-dark-hover rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-accent/50" required>
                    <input type="email" id="contact-email" placeholder="Email" class="w-full bg-light-hover dark:bg-dark-hover rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-accent/50">
                    <input type="tel" id="contact-phone" placeholder="Phone" class="w-full bg-light-hover dark:bg-dark-hover rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-accent/50">
                    <input type="text" id="contact-company" placeholder="Company" class="w-full bg-light-hover dark:bg-dark-hover rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-accent/50">
                </div>
                <div class="flex gap-3 mt-2">
                    <button type="button" onclick="closeContactModal()" class="flex-1 bg-gray-200 dark:bg-gray-700 py-3 rounded-xl font-medium">Cancel</button>
                    <button type="submit" class="flex-1 bg-accent text-white py-3 rounded-xl font-medium shadow-lg shadow-accent/20">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="url-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[60] hidden animate-fade-in p-4">
        <div class="bg-light-card dark:bg-dark-card rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-scale-in">
            <h3 class="text-xl font-bold mb-4">Add URL</h3>
            <form id="url-form" class="space-y-3">
                <input type="text" id="url-title" placeholder="Title" class="w-full bg-light-hover dark:bg-dark-hover rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-accent/50" required>
                <input type="url" id="url-link" placeholder="https://example.com" class="w-full bg-light-hover dark:bg-dark-hover rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-accent/50" required>
                <select id="url-folder-select" class="w-full bg-light-hover dark:bg-dark-hover rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-accent/50 appearance-none">
                    <option value="all">No Folder</option>
                </select>
                <textarea id="url-description" placeholder="Description (optional)" rows="3" class="w-full bg-light-hover dark:bg-dark-hover rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-accent/50 resize-none"></textarea>
                <div class="flex gap-3 mt-2">
                    <button type="button" onclick="closeUrlModal()" class="flex-1 bg-gray-200 dark:bg-gray-700 py-3 rounded-xl font-medium">Cancel</button>
                    <button type="submit" class="flex-1 bg-accent text-white py-3 rounded-xl font-medium shadow-lg shadow-accent/20">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="cloud-import-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[60] hidden animate-fade-in p-4">
        <div class="bg-light-card dark:bg-dark-card rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-scale-in">
            <h3 class="text-xl font-bold mb-4">Cloud Import</h3>
            <div class="space-y-3">
                <button onclick="importFromGooglePhotos()" class="w-full bg-[#DB4437] hover:bg-[#c53929] py-3 rounded-xl flex items-center justify-center space-x-3 text-white transition-transform active:scale-95">
                    <i data-lucide="image" class="w-5 h-5"></i>
                    <span>Google Photos</span>
                </button>
                <button onclick="importFromDropbox()" class="w-full bg-[#0061FE] hover:bg-[#0052d4] py-3 rounded-xl flex items-center justify-center space-x-3 text-white transition-transform active:scale-95">
                    <i data-lucide="cloud" class="w-5 h-5"></i>
                    <span>Dropbox</span>
                </button>
                <button onclick="importFromOneDrive()" class="w-full bg-[#0078D4] hover:bg-[#0067b8] py-3 rounded-xl flex items-center justify-center space-x-3 text-white transition-transform active:scale-95">
                    <i data-lucide="cloud" class="w-5 h-5"></i>
                    <span>OneDrive</span>
                </button>
                <button onclick="closeCloudImportModal()" class="w-full bg-gray-200 dark:bg-gray-700 py-3 rounded-xl font-medium mt-2">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="photo-editor-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center z-[70] hidden animate-fade-in">
        <div class="bg-light-card dark:bg-dark-card w-full h-full md:w-[90%] md:h-[90%] md:rounded-2xl flex flex-col md:flex-row overflow-hidden relative">
            <button onclick="closePhotoEditor()" class="absolute top-4 right-4 z-50 p-2 bg-black/50 rounded-full text-white hover:bg-black/70">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <div class="flex-1 bg-black flex items-center justify-center p-4 relative">
                <canvas id="photo-editor-canvas" class="max-w-full max-h-full object-contain"></canvas>
            </div>
            <div class="h-auto md:w-80 bg-light-card dark:bg-dark-card border-t md:border-t-0 md:border-l border-light-border dark:border-dark-border p-4 flex flex-row md:flex-col gap-4 items-center justify-center shrink-0 overflow-x-auto">
                <button onclick="cropPhoto()" class="flex-1 md:w-full py-3 px-4 bg-accent text-white rounded-xl flex flex-col md:flex-row items-center justify-center gap-2">
                    <i data-lucide="crop" class="w-5 h-5"></i> <span class="text-xs md:text-sm">Crop</span>
                </button>
                <button onclick="rotatePhoto()" class="flex-1 md:w-full py-3 px-4 bg-gray-200 dark:bg-gray-700 rounded-xl flex flex-col md:flex-row items-center justify-center gap-2">
                    <i data-lucide="rotate-cw" class="w-5 h-5"></i> <span class="text-xs md:text-sm">Rotate</span>
                </button>
                <button onclick="saveEditedPhoto()" class="flex-1 md:w-full py-3 px-4 bg-green-500 text-white rounded-xl flex flex-col md:flex-row items-center justify-center gap-2">
                    <i data-lucide="save" class="w-5 h-5"></i> <span class="text-xs md:text-sm">Save</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="photo-lightbox" class="fixed inset-0 bg-black z-[70] hidden flex flex-col animate-fade-in">
        <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-center z-50 bg-gradient-to-b from-black/50 to-transparent">
            <span id="lightbox-title" class="text-white font-medium truncate px-2"></span>
            <button onclick="closeLightbox()" class="text-white p-2 hover:bg-white/10 rounded-full"><i data-lucide="x" class="w-8 h-8"></i></button>
        </div>
        <div class="flex-1 flex items-center justify-center p-2 relative touch-pinch-zoom">
            <img id="lightbox-image" src="" alt="" class="max-w-full max-h-full object-contain shadow-2xl">
        </div>
        <div class="absolute bottom-0 left-0 w-full p-6 bg-gradient-to-t from-black/80 to-transparent flex justify-between items-end pb-8 md:pb-6">
            <div class="text-white/70 text-sm">
                <p id="lightbox-size"></p>
            </div>
            <div class="flex gap-4">
                <button onclick="editPhoto(currentPhotoId)" class="p-3 bg-white/10 backdrop-blur-md rounded-full text-white hover:bg-white/20"><i data-lucide="edit" class="w-6 h-6"></i></button>
                <button onclick="toggleFavorite(currentPhotoId)" class="p-3 bg-white/10 backdrop-blur-md rounded-full text-white hover:bg-white/20"><i data-lucide="heart" class="w-6 h-6"></i></button>
                <button onclick="deletePhoto(currentPhotoId)" class="p-3 bg-white/10 backdrop-blur-md rounded-full text-red-400 hover:bg-white/20"><i data-lucide="trash-2" class="w-6 h-6"></i></button>
            </div>
        </div>
    </div>

    <script>
        // Global State & Utils
        let currentApp = 'home';
        let currentPhotoId = null;
        let currentNoteId = null;
        let currentContactId = null;
        let currentTheme = 'dark';
        let selectedContacts = new Set();
        let currentPhotosView = 'all';
        let currentUrlFolder = 'all';
        let contactPictureData = null;
        let currentNotesView = 'list';
        let currentPasswordsView = 'grid';
        let currentUrlsView = 'grid';
        let notes = [], folders = [{id:'all',name:'All Notes'}], photos = [], albums = [], passwords = [], contacts = [], urls = [], urlFolders = [{id:'all',name:'All URLs'}];
        let userProfile = { name: '', email: '', bio: '', avatar: null };
        let appOrder = ['notes', 'photos', 'passwords', 'contacts', 'urls', 'settings'];
        let customBackground = null;
        let isSidebarOpen = false;

        // Function Declarations (Hoisted)
        
        function handlePhotoUpload(e) {
            const files = Array.from(e.target.files);
            if (!files.length) return;

            let processed = 0;
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.src = ev.target.result;
                    img.onload = () => {
                        // Image Compression Logic
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_SIZE = 1024; // Limit max dimension
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height *= MAX_SIZE / width;
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width *= MAX_SIZE / height;
                                height = MAX_SIZE;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Compress to JPEG 70% quality
                        const compressedUrl = canvas.toDataURL('image/jpeg', 0.7);

                        photos.unshift({
                            id: Date.now() + Math.random(),
                            url: compressedUrl,
                            name: file.name,
                            size: Math.round((compressedUrl.length * 3) / 4), // Approx size from base64
                            date: new Date(),
                            favorite: false,
                            album: 'all'
                        });
                        processed++;
                        if (processed === files.length) {
                            saveData();
                            renderPhotos();
                        }
                    };
                };
                reader.readAsDataURL(file);
            });
            e.target.value = '';
        }

        function togglePasswordsView() {
            currentPasswordsView = currentPasswordsView === 'grid' ? 'list' : 'grid';
            const icon = document.getElementById('passwords-view-icon');
            if(icon) icon.setAttribute('data-lucide', currentPasswordsView === 'grid' ? 'layout-list' : 'layout-grid');
            renderPasswords();
        }

        function setupEventListeners() {
            const bind = (id, event, func) => {
                const el = document.getElementById(id);
                if(el) el.addEventListener(event, func);
            };
            
            bind('photo-input', 'change', handlePhotoUpload);
            bind('password-form', 'submit', handlePasswordSubmit);
            bind('contact-form', 'submit', handleContactSubmit);
            bind('url-form', 'submit', handleUrlSubmit);
            bind('profile-form', 'submit', handleProfileSubmit);
            bind('contact-search', 'input', searchContacts);
            bind('note-editor', 'input', autoSaveNote);
            bind('note-title', 'input', autoSaveNote);
            bind('background-input', 'change', handleBackgroundUpload);
            bind('profile-picture-input', 'change', handleProfilePictureUpload);
            bind('contact-picture-input', 'change', handleContactPictureUpload);
            
            // Rich editor placeholders
            const editor = document.getElementById('note-editor');
            if(editor) {
                editor.addEventListener('focus', function() { if (this.textContent === '') this.innerHTML = ''; });
                editor.addEventListener('blur', function() { if (this.textContent === '') this.innerHTML = ''; });
            }
            
            // Close modals on escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeAllModals();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            try {
                if (typeof lucide === 'undefined') {
                    console.error('Lucide icons failed to load. Check internet connection.');
                } else {
                    lucide.createIcons();
                }
                
                // Initialize logic
                setupEventListeners();
                loadData();
                updateTime();
                updateHomeDateTime();
                setInterval(updateTime, 1000);
                setInterval(updateHomeDateTime, 1000);
            } catch (e) {
                console.error("App Initialization Error:", e);
                // alert("App failed to initialize. Please check console.");
            }
        });

        function closeAllModals() {
            closePasswordModal();
            closeContactModal();
            closeUrlModal();
            closeCloudImportModal();
            closeLightbox();
            closePhotoEditor();
            if(isSidebarOpen) toggleSidebar();
        }

        // --- Core UI Functions ---

        function toggleSidebar() {
            isSidebarOpen = !isSidebarOpen;
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (isSidebarOpen) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        function switchApp(appName) {
            // Hide all apps
            document.querySelectorAll('.app-content').forEach(app => app.classList.add('hidden'));
            
            // Show target app
            const targetApp = document.getElementById(appName + '-app');
            if (targetApp) {
                targetApp.classList.remove('hidden');
                targetApp.classList.add('animate-fade-in');
            }
            
            // Update Header Title
            const titleMap = {
                'home': "Shivam's Essential Toolkit Pro",
                'urls': 'URL Dashboard'
            };
            const titleEl = document.getElementById('app-title');
            if(titleEl) titleEl.textContent = titleMap[appName] || appName.charAt(0).toUpperCase() + appName.slice(1);
            
            // Update active state in sidebar
            document.querySelectorAll('.sidebar-btn').forEach(btn => {
                btn.classList.remove('bg-light-hover', 'dark:bg-dark-hover', 'text-accent');
                if (btn.dataset.app === appName) {
                    btn.classList.add('bg-light-hover', 'dark:bg-dark-hover', 'text-accent');
                }
            });
            
            currentApp = appName;
            
            // Close sidebar on mobile after selection
            if (isSidebarOpen && window.innerWidth < 768) {
                toggleSidebar();
            }
            
            if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
        }

        // --- Mobile Navigation Logic for Notes & Contacts ---

        function mobileNavigateNotes(view) {
            const foldersPanel = document.getElementById('notes-folders-panel');
            const listPanel = document.getElementById('notes-list-panel');
            const editorPanel = document.getElementById('notes-editor-panel');
            
            if (window.innerWidth >= 768) return; 

            foldersPanel.classList.add('hidden');
            listPanel.classList.add('hidden');
            editorPanel.classList.add('hidden');
            
            if (view === 'folders') {
                foldersPanel.classList.remove('hidden');
                foldersPanel.classList.add('flex');
            } else if (view === 'list') {
                listPanel.classList.remove('hidden');
                listPanel.classList.add('flex');
            } else if (view === 'editor') {
                editorPanel.classList.remove('hidden');
                editorPanel.classList.add('flex');
            }
        }

        function mobileNavigateContacts(view) {
            const listPanel = document.getElementById('contacts-list-panel');
            const detailsPanel = document.getElementById('contacts-details-panel');
            
            if (window.innerWidth >= 768) return;

            if (view === 'list') {
                listPanel.classList.remove('hidden');
                detailsPanel.classList.add('hidden');
            } else {
                listPanel.classList.add('hidden');
                detailsPanel.classList.remove('hidden');
                detailsPanel.classList.add('block');
            }
        }

        // --- Notes App Logic ---

        function toggleNotesView() {
            currentNotesView = currentNotesView === 'list' ? 'grid' : 'list';
            const icon = document.getElementById('notes-view-icon');
            if(icon) icon.setAttribute('data-lucide', currentNotesView === 'grid' ? 'list' : 'layout-grid');
            renderNotes();
        }

        function createNote() {
            const note = { id: Date.now(), title: 'Untitled Note', content: '', folder: 'all', created: new Date(), modified: new Date() };
            notes.unshift(note);
            renderNotes();
            selectNote(note.id);
            saveData();
        }

        function selectNote(noteId) {
            currentNoteId = noteId;
            const note = notes.find(n => n.id === noteId);
            if (note) {
                document.getElementById('note-title').value = note.title;
                document.getElementById('note-editor').innerHTML = note.content;
                document.getElementById('note-status').textContent = 'Saved';
                
                document.querySelectorAll('.note-item').forEach(item => {
                    item.classList.remove('border-accent', 'bg-accent/5');
                    if (parseInt(item.dataset.noteId) === noteId) {
                        item.classList.add('border-accent', 'bg-accent/5');
                    }
                });
                mobileNavigateNotes('editor');
            }
        }

        function renderNotes() {
            const notesList = document.getElementById('notes-list');
            if(!notesList) return;
            notesList.innerHTML = '';
            notesList.className = currentNotesView === 'grid' 
                ? 'flex-1 overflow-y-auto p-3 grid grid-cols-2 gap-2 content-start pb-20 md:pb-3' 
                : 'flex-1 overflow-y-auto p-3 space-y-2 pb-20 md:pb-3';
            
            if(notes.length === 0) {
                notesList.innerHTML = `<div class="col-span-full text-center text-gray-400 mt-10"><i data-lucide="file-plus" class="w-8 h-8 mx-auto mb-2 opacity-50"></i><p class="text-sm">Create a note</p></div>`;
            }

            notes.forEach(note => {
                const el = document.createElement('div');
                el.dataset.noteId = note.id;
                el.onclick = () => selectNote(note.id);
                el.className = `note-item p-3 rounded-xl cursor-pointer border border-transparent transition-all duration-200 hover:bg-light-hover dark:hover:bg-dark-hover ${currentNoteId === note.id ? 'border-accent bg-accent/5' : ''}`;
                
                const tmp = document.createElement('DIV');
                tmp.innerHTML = note.content;
                const previewText = tmp.textContent || tmp.innerText || "";

                if (currentNotesView === 'grid') {
                    el.innerHTML = `
                        <h4 class="font-semibold truncate text-sm mb-1">${note.title}</h4>
                        <p class="text-xs text-gray-500 line-clamp-3 mb-2 h-10">${previewText}</p>
                        <div class="flex justify-between items-center mt-auto">
                            <span class="text-[10px] text-gray-400">${new Date(note.modified).toLocaleDateString()}</span>
                            <button onclick="event.stopPropagation(); deleteNote(${note.id})" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                    `;
                    el.classList.add('flex', 'flex-col', 'h-32', 'bg-light-card', 'dark:bg-dark-card', 'shadow-sm');
                } else {
                    el.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h4 class="font-semibold truncate text-sm flex-1">${note.title}</h4>
                            <span class="text-[10px] text-gray-400 ml-2 whitespace-nowrap">${new Date(note.modified).toLocaleDateString()}</span>
                        </div>
                        <p class="text-xs text-gray-500 truncate mt-0.5">${previewText}</p>
                        <button onclick="event.stopPropagation(); deleteNote(${note.id})" class="text-gray-400 hover:text-red-500 mt-1"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    `;
                }
                notesList.appendChild(el);
            });
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function deleteNote(id) {
            if(confirm('Delete note?')) {
                notes = notes.filter(n => n.id !== id);
                if(currentNoteId === id) {
                    currentNoteId = null;
                    document.getElementById('note-title').value = '';
                    document.getElementById('note-editor').innerHTML = '';
                    mobileNavigateNotes('list');
                }
                renderNotes();
                saveData();
            }
        }

        function autoSaveNote() {
            if (currentNoteId) {
                const note = notes.find(n => n.id === currentNoteId);
                if (note) {
                    note.title = document.getElementById('note-title').value || 'Untitled';
                    note.content = document.getElementById('note-editor').innerHTML;
                    note.modified = new Date();
                    document.getElementById('note-status').textContent = 'Saving...';
                    setTimeout(() => document.getElementById('note-status').textContent = 'Saved', 500);
                    renderNotes();
                    saveData();
                }
            }
        }

        // --- Photos App Logic ---

        function renderPhotos() {
            const grid = document.getElementById('photos-grid');
            if (!grid) return;
            grid.innerHTML = '';
            
            let filteredPhotos = photos;
            if (currentPhotosView === 'albums') {
                // Should show photos from active album if implemented, for now show all
            }
            
            if (filteredPhotos.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10">No photos yet</div>`;
                return;
            }

            filteredPhotos.forEach(photo => {
                const div = document.createElement('div');
                div.className = 'aspect-square bg-gray-100 dark:bg-gray-800 rounded-xl overflow-hidden relative group cursor-pointer';
                div.onclick = () => openLightbox(photo.id);
                div.innerHTML = `
                    <img src="${photo.url}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
                    ${photo.favorite ? '<div class="absolute top-2 right-2 text-red-500"><i data-lucide="heart" class="w-4 h-4 fill-current"></i></div>' : ''}
                `;
                grid.appendChild(div);
            });
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function openLightbox(id) {
            currentPhotoId = id;
            const photo = photos.find(p => p.id === id);
            if (!photo) return;
            
            const lightbox = document.getElementById('photo-lightbox');
            document.getElementById('lightbox-image').src = photo.url;
            document.getElementById('lightbox-title').textContent = photo.name;
            document.getElementById('lightbox-size').textContent = formatFileSize(photo.size);
            lightbox.classList.remove('hidden');
        }

        function showPhotosView(view) {
            currentPhotosView = view;
            document.querySelectorAll('.photos-tab').forEach(btn => {
                if(btn.dataset.view === view) {
                    btn.classList.remove('bg-light-card', 'dark:bg-dark-card', 'hover:bg-gray-200', 'dark:hover:bg-gray-700');
                    btn.classList.add('bg-accent', 'text-white');
                } else {
                    btn.classList.add('bg-light-card', 'dark:bg-dark-card', 'hover:bg-gray-200', 'dark:hover:bg-gray-700');
                    btn.classList.remove('bg-accent', 'text-white');
                }
            });
            
            const albumsList = document.getElementById('albums-list');
            const photosGrid = document.getElementById('photos-grid');
            
            if (view === 'albums') {
                albumsList.classList.remove('hidden');
                photosGrid.classList.add('hidden');
                renderAlbums();
            } else {
                albumsList.classList.add('hidden');
                photosGrid.classList.remove('hidden');
                renderPhotos();
            }
        }

        function createAlbum() {
            const name = prompt("Album Name:");
            if (name) {
                albums.push({ id: Date.now(), name: name, count: 0 });
                saveData();
                if (currentPhotosView === 'albums') renderAlbums();
            }
        }

        function renderAlbums() {
            const list = document.getElementById('albums-list');
            if(!list) return;
            list.innerHTML = '';
            albums.forEach(album => {
                const div = document.createElement('div');
                div.className = 'aspect-square bg-gray-200 dark:bg-gray-800 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors';
                div.innerHTML = `
                    <i data-lucide="folder" class="w-10 h-10 text-accent mb-2"></i>
                    <span class="font-medium truncate max-w-[80%]">${album.name}</span>
                    <span class="text-xs text-gray-500">${album.count || 0} items</span>
                `;
                list.appendChild(div);
            });
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        function editPhoto(id) {
             const photo = photos.find(p => p.id === id);
             if(!photo) return;
             document.getElementById('photo-lightbox').classList.add('hidden');
             const editor = document.getElementById('photo-editor-modal');
             editor.classList.remove('hidden');
             
             const canvas = document.getElementById('photo-editor-canvas');
             const ctx = canvas.getContext('2d');
             const img = new Image();
             img.onload = () => {
                 canvas.width = img.width;
                 canvas.height = img.height;
                 ctx.drawImage(img, 0, 0);
             };
             img.src = photo.url;
        }

        function toggleFavorite(id) {
            const photo = photos.find(p => p.id === id);
            if (photo) {
                photo.favorite = !photo.favorite;
                saveData();
                renderPhotos();
            }
        }

        function deletePhoto(id) {
            if(confirm("Delete this photo?")) {
                photos = photos.filter(p => p.id !== id);
                saveData();
                renderPhotos();
                closeLightbox();
            }
        }

        // --- Contacts App Logic ---

        function renderContacts() {
            const list = document.getElementById('contacts-list');
            const search = document.getElementById('contact-search').value.toLowerCase();
            list.innerHTML = '';
            
            const filtered = contacts.filter(c => c.name.toLowerCase().includes(search) || (c.email && c.email.toLowerCase().includes(search)));
            
            if(filtered.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-400 py-10"><p>No contacts found</p></div>`;
                return;
            }

            filtered.forEach(c => {
                const el = document.createElement('div');
                el.className = `contact-item p-3 rounded-xl hover:bg-light-hover dark:hover:bg-dark-hover cursor-pointer transition-all flex items-center space-x-3 mb-1 ${currentContactId === c.id ? 'bg-accent/10' : ''}`;
                el.onclick = () => selectContact(c.id);
                el.innerHTML = `
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold overflow-hidden shrink-0">
                        ${c.picture ? `<img src="${c.picture}" class="w-full h-full object-cover">` : c.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-medium truncate text-sm">${c.name}</h4>
                        <p class="text-xs text-gray-500 truncate">${c.email || ''}</p>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function openContactAction(type, value) {
            if (!value) return;
            if (type === 'call') window.open(`tel:${value}`, '_self');
            if (type === 'email') window.open(`mailto:${value}`);
            if (type === 'chat') {
                const cleanPhone = value.replace(/\D/g, '');
                window.open(`https://wa.me/${cleanPhone}`, '_blank');
            }
        }

        function selectContact(id) {
            currentContactId = id;
            const c = contacts.find(x => x.id === id);
            if(c) {
                const details = document.getElementById('contact-details');
                
                let actionButtons = '';
                if(c.phone) actionButtons += `<button onclick="openContactAction('call', '${c.phone}')" class="flex-1 bg-green-500 text-white py-2 rounded-xl flex flex-col items-center justify-center shadow-lg shadow-green-500/20 active:scale-95 transition-transform"><i data-lucide="phone" class="w-5 h-5 mb-1"></i> <span class="text-xs">Call</span></button>`;
                if(c.email) actionButtons += `<button onclick="openContactAction('email', '${c.email}')" class="flex-1 bg-blue-500 text-white py-2 rounded-xl flex flex-col items-center justify-center shadow-lg shadow-blue-500/20 active:scale-95 transition-transform"><i data-lucide="mail" class="w-5 h-5 mb-1"></i> <span class="text-xs">Email</span></button>`;
                if(c.phone) actionButtons += `<button onclick="openContactAction('chat', '${c.phone}')" class="flex-1 bg-[#25D366] text-white py-2 rounded-xl flex flex-col items-center justify-center shadow-lg shadow-[#25D366]/20 active:scale-95 transition-transform"><i data-lucide="message-circle" class="w-5 h-5 mb-1"></i> <span class="text-xs">Chat</span></button>`;

                let infoCards = '';
                if(c.email) infoCards += `<div class="bg-light-card dark:bg-dark-card p-4 rounded-xl border border-light-border dark:border-dark-border flex items-center space-x-4"><div class="p-2 bg-gray-100 dark:bg-gray-800 rounded-lg"><i data-lucide="mail" class="w-5 h-5 text-gray-500"></i></div><div class="flex-1 overflow-hidden"><p class="text-xs text-gray-400 uppercase font-semibold">Email</p><p class="truncate">${c.email}</p></div></div>`;
                if(c.phone) infoCards += `<div class="bg-light-card dark:bg-dark-card p-4 rounded-xl border border-light-border dark:border-dark-border flex items-center space-x-4"><div class="p-2 bg-gray-100 dark:bg-gray-800 rounded-lg"><i data-lucide="phone" class="w-5 h-5 text-gray-500"></i></div><div class="flex-1 overflow-hidden"><p class="text-xs text-gray-400 uppercase font-semibold">Phone</p><p class="truncate">${c.phone}</p></div></div>`;
                if(c.company) infoCards += `<div class="bg-light-card dark:bg-dark-card p-4 rounded-xl border border-light-border dark:border-dark-border flex items-center space-x-4"><div class="p-2 bg-gray-100 dark:bg-gray-800 rounded-lg"><i data-lucide="briefcase" class="w-5 h-5 text-gray-500"></i></div><div class="flex-1 overflow-hidden"><p class="text-xs text-gray-400 uppercase font-semibold">Company</p><p class="truncate">${c.company}</p></div></div>`;

                // If no info cards, show a placeholder message or nothing
                if(!infoCards) infoCards = `<p class="text-center text-gray-400 text-sm italic">No additional details</p>`;

                const avatarContent = c.picture 
                    ? `<img src="${c.picture}" class="w-full h-full object-cover">` 
                    : (c.name ? c.name.charAt(0).toUpperCase() : '?');

                details.innerHTML = `
                    <div class="flex flex-col items-center h-full overflow-y-auto animate-fade-in pt-8 pb-20 w-full">
                        <div class="w-28 h-28 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white text-4xl font-bold mb-4 overflow-hidden shadow-2xl shrink-0 ring-4 ring-light-bg dark:ring-dark-bg">
                            ${avatarContent}
                        </div>
                        <h2 class="text-3xl font-bold mb-1 text-center px-4">${c.name || 'Unknown'}</h2>
                        <p class="text-gray-500 mb-8 text-center px-4 font-medium">${c.company || 'No Company'}</p>
                        
                        ${actionButtons ? `<div class="flex gap-4 mb-8 w-full max-w-sm px-6 justify-center">${actionButtons}</div>` : ''}

                        <div class="w-full max-w-md space-y-3 px-6 flex-1">
                            ${infoCards}
                        </div>

                        <div class="mt-8 px-6 w-full max-w-md pb-8">
                            <button onclick="deleteContact(${c.id})" class="w-full text-red-500 hover:bg-red-50 dark:hover:bg-red-900/10 px-4 py-3 rounded-xl transition-colors flex items-center justify-center gap-2 border border-transparent hover:border-red-200 dark:hover:border-red-900/30">
                                <i data-lucide="trash-2" class="w-5 h-5"></i> Delete Contact
                            </button>
                        </div>
                    </div>
                `;
                if(typeof lucide !== 'undefined') lucide.createIcons();
                renderContacts(); // Update highlight
                mobileNavigateContacts('details');
            }
        }

        function selectAllContacts() {
            // Placeholder logic
            alert("All contacts selected");
        }

        function exportContacts() {
            alert("Exporting contacts to VCF...");
        }

        function deleteContact(id) {
            if(confirm("Delete contact?")) {
                contacts = contacts.filter(c => c.id !== id);
                if (currentContactId === id) {
                    currentContactId = null;
                    const details = document.getElementById('contact-details');
                    if(details) {
                        details.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-6 text-center text-gray-400"><div><i data-lucide="user" class="w-20 h-20 mx-auto mb-4 opacity-20"></i><p>Select a contact to view details</p></div></div>`;
                        if(typeof lucide !== 'undefined') lucide.createIcons();
                    }
                }
                saveData();
                renderContacts();
            }
        }

        // --- Standard functions from original (abbreviated where logic is same) ---
        function formatText(cmd) { document.execCommand(cmd, false, null); }
        function createFolder() { const n = prompt('Folder Name:'); if(n) { folders.push({id:Date.now(),name:n}); saveData(); } }
        function openCloudImportModal() { document.getElementById('cloud-import-modal').classList.remove('hidden'); }
        function closeCloudImportModal() { document.getElementById('cloud-import-modal').classList.add('hidden'); }
        function importFromGooglePhotos() { alert('Importing from Google Photos...'); closeCloudImportModal(); }
        function importFromDropbox() { alert('Importing from Dropbox...'); closeCloudImportModal(); }
        function importFromOneDrive() { alert('Importing from OneDrive...'); closeCloudImportModal(); }
        function formatFileSize(bytes) { if(bytes===0) return '0 B'; const k=1024, sizes=['B','KB','MB','GB'], i=Math.floor(Math.log(bytes)/Math.log(k)); return parseFloat((bytes/Math.pow(k,i)).toFixed(2))+' '+sizes[i]; }
        
        // --- Persistence ---
        function saveData() {
            try {
                localStorage.setItem('toolkitData', JSON.stringify({
                    version: 1, timestamp: Date.now(), notes, folders, photos, albums, passwords, contacts, urls, urlFolders, userProfile, appOrder, customBackground, theme: currentTheme
                }));
            } catch(e) {
                console.error("Save failed", e);
                if (e.name === 'QuotaExceededError') {
                    alert("Storage full! Unable to save recent changes. Please delete some photos to free up space.");
                } else {
                    alert("Save failed! " + e.message);
                }
            }
        }
        function loadData() {
            const saved = localStorage.getItem('toolkitData');
            if(saved) {
                try {
                    const d = JSON.parse(saved);
                    currentTheme = d.theme || 'dark'; setTheme(currentTheme);
                    userProfile = d.userProfile || userProfile; loadProfile();
                    notes = (d.notes||[]).map(n=>({...n, created:new Date(n.created), modified:new Date(n.modified)}));
                    photos = (d.photos||[]).map(p=>({...p, uploaded:new Date(p.uploaded)}));
                    contacts = d.contacts||[]; passwords = d.passwords||[]; urls = d.urls||[];
                    // Robustly load folders, ensure array, ensure 'all' exists
                    urlFolders = Array.isArray(d.urlFolders) ? d.urlFolders : [{id:'all', name: 'All URLs'}];
                    if (!urlFolders.some(f => f.id === 'all')) {
                        urlFolders.unshift({id:'all', name: 'All URLs'});
                    }
                    
                    customBackground = d.customBackground; applyCustomBackground();
                    appOrder = d.appOrder || appOrder;
                } catch(e) { console.error(e); loadSampleData(); }
            } else { loadSampleData(); saveData(); }
            
            renderAppsGrid(); renderNotes(); renderPhotos(); renderPasswords(); renderContacts(); renderUrls(); renderUrlFolders(); updateUrlFolderSelect();
        }
        function loadSampleData() {
            notes = [{id:1, title:'Welcome', content:'Welcome to your new mobile-optimized OS!', folder:'all', created:new Date(), modified:new Date()}];
        }

        // --- Other Render Functions (simplified for brevity, logic identical to previous but ensuring correct DOM IDs) ---
        function renderAppsGrid() {
            const grid = document.getElementById('apps-grid');
            if(!grid) return;
            grid.innerHTML = '';
            
            const appConfigs = [
                {id:'notes', name:'Notes', icon:'file-text', color:'bg-yellow-500'},
                {id:'photos', name:'Photos', icon:'image', color:'bg-blue-500'},
                {id:'passwords', name:'Passwords', icon:'key', color:'bg-red-500'},
                {id:'contacts', name:'Contacts', icon:'users', color:'bg-green-500'},
                {id:'urls', name:'URLs', icon:'link', color:'bg-purple-500'},
                {id:'settings', name:'Settings', icon:'settings', color:'bg-gray-500'}
            ];
            
            // Map appOrder to configs
            const apps = appConfigs; // Fallback if sort fails
            
            appConfigs.forEach(app => {
                const div = document.createElement('div');
                div.className = 'app-card bg-white/10 backdrop-blur-md rounded-2xl p-4 flex flex-col items-center justify-center cursor-pointer hover:bg-white/20 transition-all active:scale-95 shadow-lg border border-white/5';
                div.onclick = () => switchApp(app.id);
                div.innerHTML = `
                    <div class="w-12 h-12 md:w-14 md:h-14 ${app.color} rounded-2xl flex items-center justify-center mb-3 shadow-lg shadow-${app.color}/30">
                        <i data-lucide="${app.icon}" class="w-6 h-6 md:w-7 md:h-7 text-white"></i>
                    </div>
                    <span class="text-white font-medium text-sm">${app.name}</span>
                `;
                grid.appendChild(div);
            });
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- Helper functions for modals, passwords, urls, profile same as before ---
        function openPasswordModal() { document.getElementById('password-modal').classList.remove('hidden'); }
        function closePasswordModal() { document.getElementById('password-modal').classList.add('hidden'); }
        function handlePasswordSubmit(e) { e.preventDefault(); const s=document.getElementById('service-name').value, u=document.getElementById('service-url').value, user=document.getElementById('username').value, pass=document.getElementById('password').value; passwords.unshift({id:Date.now(), service:s, url:u, username:user, password:pass}); renderPasswords(); saveData(); closePasswordModal(); }
        
        function renderPasswords() {
            const c = document.getElementById('passwords-container'); 
            if(!c) return;
            c.innerHTML='';
            
            // Update container class based on view
            c.className = currentPasswordsView === 'grid' 
                ? "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20" 
                : "flex flex-col gap-2 pb-20";

            if(passwords.length===0) c.innerHTML=`<div class="col-span-full text-center text-gray-400 py-10">No passwords</div>`;
            
            passwords.forEach(p => {
                const el = document.createElement('div');
                if (currentPasswordsView === 'grid') {
                    el.className = 'bg-light-card dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-light-border dark:border-dark-border';
                    el.innerHTML = `
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 bg-gray-100 dark:bg-gray-800 rounded-xl flex items-center justify-center font-bold text-lg text-accent uppercase">${p.service.charAt(0)}</div>
                            <div class="overflow-hidden"><h4 class="font-bold truncate">${p.service}</h4><p class="text-xs text-gray-500 truncate">${p.username}</p></div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-2 flex justify-between items-center mb-3">
                            <input type="password" value="${p.password}" readonly class="bg-transparent border-none w-full text-sm font-mono tracking-wider outline-none text-gray-600 dark:text-gray-300">
                            <button onclick="navigator.clipboard.writeText('${p.password}')" class="text-accent p-1"><i data-lucide="copy" class="w-4 h-4"></i></button>
                        </div>
                        <button onclick="if(confirm('Delete?')){passwords=passwords.filter(x=>x.id!==${p.id});renderPasswords();saveData();}" class="text-xs text-red-400 w-full text-center py-1">Remove</button>
                    `;
                } else {
                    el.className = 'bg-light-card dark:bg-dark-card rounded-xl p-3 shadow-sm border border-light-border dark:border-dark-border flex items-center justify-between';
                    el.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-8 h-8 bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center justify-center font-bold text-sm text-accent uppercase shrink-0">${p.service.charAt(0)}</div>
                            <div class="truncate"><h4 class="font-bold text-sm truncate">${p.service}</h4><p class="text-[10px] text-gray-500 truncate">${p.username}</p></div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="navigator.clipboard.writeText('${p.password}')" class="p-2 text-accent hover:bg-accent/10 rounded-lg"><i data-lucide="copy" class="w-4 h-4"></i></button>
                            <button onclick="if(confirm('Delete?')){passwords=passwords.filter(x=>x.id!==${p.id});renderPasswords();saveData();}" class="p-2 text-red-400 hover:bg-red-500/10 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    `;
                }
                c.appendChild(el);
            });
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- Theme & Settings ---
        function toggleTheme() { currentTheme = currentTheme === 'dark' ? 'light' : 'dark'; setTheme(currentTheme); saveData(); }
        function setTheme(t) {
            currentTheme = t;
            if(t === 'dark') { document.documentElement.classList.add('dark'); document.documentElement.classList.remove('light'); }
            else if(t === 'light') { document.documentElement.classList.add('light'); document.documentElement.classList.remove('dark'); }
            else { 
                if(window.matchMedia('(prefers-color-scheme: dark)').matches) { document.documentElement.classList.add('dark'); document.documentElement.classList.remove('light'); }
                else { document.documentElement.classList.add('light'); document.documentElement.classList.remove('dark'); }
            }
        }
        function applyCustomBackground() {
            const home = document.getElementById('home-app');
            if(customBackground) { home.style.backgroundImage = `url(${customBackground})`; home.classList.add('custom-bg'); }
            else { home.style.backgroundImage = ''; home.classList.remove('custom-bg'); }
        }
        function handleBackgroundUpload(e) {
            const f = e.target.files[0];
            if(f) { const r = new FileReader(); r.onload = ev => { customBackground = ev.target.result; applyCustomBackground(); saveData(); }; r.readAsDataURL(f); }
        }
        function removeBackground() { customBackground = null; applyCustomBackground(); saveData(); }
        function resetAppOrder() { appOrder=['notes','photos','passwords','contacts','urls','settings']; saveData(); renderAppsGrid(); }

        // --- Time ---
        function updateTime() { document.getElementById('current-time').textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
        function updateHomeDateTime() { document.getElementById('home-date-time').textContent = new Date().toLocaleDateString('en-US', {weekday:'long', year:'numeric', month:'long', day:'numeric'}); }

        // --- Profile ---
        function loadProfile() {
            document.getElementById('profile-name').value = userProfile.name;
            document.getElementById('profile-email').value = userProfile.email;
            document.getElementById('profile-bio').value = userProfile.bio;
            if(userProfile.avatar) document.getElementById('profile-avatar').innerHTML = `<img src="${userProfile.avatar}" class="w-full h-full object-cover">`;
        }
        function changeProfilePicture() { document.getElementById('profile-picture-input').click(); }
        function handleProfilePictureUpload(e) {
            const f = e.target.files[0];
            if(f) { const r = new FileReader(); r.onload = ev => { userProfile.avatar = ev.target.result; loadProfile(); saveData(); }; r.readAsDataURL(f); }
        }
        function handleProfileSubmit(e) {
            e.preventDefault();
            userProfile.name = document.getElementById('profile-name').value;
            userProfile.email = document.getElementById('profile-email').value;
            userProfile.bio = document.getElementById('profile-bio').value;
            saveData(); alert('Profile Saved');
        }

        // --- URL App ---
        function toggleUrlsView() { currentUrlsView = currentUrlsView==='grid'?'list':'grid'; document.getElementById('urls-view-icon').setAttribute('data-lucide', currentUrlsView==='list'?'layout-grid':'layout-list'); renderUrls(); }
        function openUrlModal() { document.getElementById('url-modal').classList.remove('hidden'); updateUrlFolderSelect(); }
        function closeUrlModal() { document.getElementById('url-modal').classList.add('hidden'); }
        function handleUrlSubmit(e) { 
            e.preventDefault(); 
            const t=document.getElementById('url-title').value;
            const l=document.getElementById('url-link').value;
            const f=document.getElementById('url-folder-select').value;
            urls.unshift({id:Date.now(), title:t, url:l, folder:f, created:new Date()}); 
            renderUrls(); saveData(); closeUrlModal(); 
        }
        function renderUrls() {
            const c = document.getElementById('urls-container'); 
            if(!c) return;
            c.innerHTML='';
            
            const filtered = currentUrlFolder === 'all' ? urls : urls.filter(u => u.folder === currentUrlFolder);
            
            if(filtered.length===0) c.innerHTML=`<div class="col-span-full text-center text-gray-400 py-10">No URLs saved</div>`;
            
            filtered.forEach(u => {
                const el = document.createElement('div');
                el.className = 'bg-light-card dark:bg-dark-card rounded-2xl p-4 shadow-sm border border-light-border dark:border-dark-border cursor-pointer hover:scale-105 transition-transform';
                el.onclick = () => window.open(u.url, '_blank');
                el.innerHTML = `
                    <div class="flex items-center gap-3 mb-2">
                        <img src="https://www.google.com/s2/favicons?domain=${new URL(u.url).hostname}&sz=32" class="w-6 h-6 rounded" onerror="this.src='data:image/svg+xml;base64,PHNvg...'">
                        <h4 class="font-bold truncate text-sm flex-1">${u.title}</h4>
                    </div>
                    <p class="text-xs text-gray-500 truncate mb-2">${u.url}</p>
                    <button onclick="event.stopPropagation();if(confirm('Delete?')){urls=urls.filter(x=>x.id!==${u.id});renderUrls();saveData();}" class="text-xs text-red-400">Remove</button>
                `;
                c.appendChild(el);
            });
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        function createUrlFolder() {
            const name = prompt("Folder Name:");
            if(name && name.trim() !== "") {
                const cleanName = name.trim();
                // Prevent duplicate names roughly
                if(!urlFolders.find(f => f.name === cleanName)) {
                    urlFolders.push({id: Date.now(), name: cleanName});
                    saveData();
                    renderUrlFolders();
                    updateUrlFolderSelect();
                    // Auto-select new folder
                    filterUrls(cleanName);
                } else {
                    alert("Folder already exists!");
                }
            }
        }
        
        function renderUrlFolders() {
            const container = document.getElementById('url-folders');
            if(!container) return;
            container.innerHTML = '';
            
            // Add 'All' button
            const allBtn = document.createElement('button');
            const baseClass = "url-folder-btn px-3 py-1.5 rounded-full text-sm shadow-sm transition-all whitespace-nowrap";
            
            allBtn.className = `${baseClass} ${currentUrlFolder === 'all' ? 'bg-accent text-white' : 'bg-light-card dark:bg-dark-card hover:bg-gray-200 dark:hover:bg-gray-700'}`;
            allBtn.textContent = 'All';
            allBtn.onclick = () => filterUrls('all');
            container.appendChild(allBtn);
            
            urlFolders.forEach(folder => {
                if(folder.id === 'all') return; // Skip if manually added to array, though we handle 'all' separately
                const btn = document.createElement('button');
                btn.className = `${baseClass} ${currentUrlFolder === folder.name ? 'bg-accent text-white' : 'bg-light-card dark:bg-dark-card hover:bg-gray-200 dark:hover:bg-gray-700'}`;
                btn.textContent = folder.name;
                btn.onclick = () => filterUrls(folder.name);
                container.appendChild(btn);
            });
        }
        
        function updateUrlFolderSelect() {
            const select = document.getElementById('url-folder-select');
            if(!select) return;
            select.innerHTML = '<option value="all">No Folder</option>';
            urlFolders.forEach(folder => {
                if(folder.id === 'all') return;
                const option = document.createElement('option');
                option.value = folder.name;
                option.textContent = folder.name;
                select.appendChild(option);
            });
        }
        
        function filterUrls(folderName) {
            currentUrlFolder = folderName;
            renderUrlFolders(); // Re-render to update active state
            renderUrls();
        }

        // --- Drag & Drop (Simple Implementation) ---
        function initializeAppDragDrop() {
            // Drag and drop logic can be complex on mobile touch events.
            // Keeping it basic for desktop for now.
        }
        
        // --- Photo Modal Wrappers ---
        function closePhotoEditor() { document.getElementById('photo-editor-modal').classList.add('hidden'); }
        function closeLightbox() { document.getElementById('photo-lightbox').classList.add('hidden'); }
        function cropPhoto() { alert('Crop tool would open here'); }
        function rotatePhoto() { alert('Rotate tool'); }
        function saveEditedPhoto() { alert('Photo saved'); closePhotoEditor(); }
        
        function openContactModal() { document.getElementById('contact-modal').classList.remove('hidden'); }
        function closeContactModal() { document.getElementById('contact-modal').classList.add('hidden'); }
        function handleContactSubmit(e) { 
            e.preventDefault(); 
            const name = document.getElementById('contact-name').value;
            const email = document.getElementById('contact-email').value;
            const phone = document.getElementById('contact-phone').value;
            const company = document.getElementById('contact-company').value;
            contacts.push({id:Date.now(), name, email, phone, company, picture:contactPictureData, created:new Date()});
            renderContacts(); saveData(); closeContactModal();
        }
        function handleContactPictureUpload(e) {
            const f = e.target.files[0];
            if(f) { const r = new FileReader(); r.onload = ev => { contactPictureData = ev.target.result; document.getElementById('contact-avatar-preview').innerHTML = `<img src="${contactPictureData}" class="w-full h-full object-cover">`; }; r.readAsDataURL(f); }
        }
        function searchContacts() { renderContacts(); }

    </script>
</body>
</html>